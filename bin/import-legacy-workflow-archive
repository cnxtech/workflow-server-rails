#!/usr/bin/env ruby
# frozen_string_literal: true

# This script imports a CSV file into the database.  The CSV file was created by
# exporting the data from the legacy Oracle database.
#
# Usage:
#   ./bin/import-legacy-workflow-archive <pathToCSV>

puts 'Loading environment...'
require File.expand_path('../config/environment', __dir__)

require 'csv'

CSV.open(ARGV[0], headers: :first_row).each_slice(10_000) do |batch|
  values = batch.map do |line|
    legacy = line.to_h

    # Renamed fields
    created_at = legacy.delete('datetime')
    workflow = legacy.delete('datastream')
    # We must provide updated_at, or it will display as the import time in the lifecycle.
    legacy.merge(workflow: workflow, created_at: created_at, updated_at: created_at)
  end

  WorkflowStep.import values
end
